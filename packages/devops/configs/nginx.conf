# For more information on configuration, see:
#   * Official English Documentation: http://nginx.org/en/docs/
#   * Official Russian Documentation: http://nginx.org/ru/docs/

user www-data;
worker_processes auto;
error_log /var/log/nginx/error.log;
pid /var/run/nginx.pid;

# Load dynamic modules. See /usr/share/doc/nginx/README.dynamic.
include /usr/share/nginx/modules/*.conf;

events {
    worker_connections 1024;
}

http {
      # Hide Nginx version information.
      include h5bp/security/server_software_information.conf;

      # Specify media (MIME) types for files.
      include h5bp/media_types/media_types.conf;

      # Set character encodings.
      include h5bp/media_types/character_encodings.conf;

    log_format  main  '$remote_addr - $remote_user [$time_local] ($request_time) "$request" $request_length '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';

    access_log  /var/log/nginx/access.log  main;

    sendfile            on;
    tcp_nopush          on;
    tcp_nodelay         on;
    keepalive_timeout   65;
    types_hash_max_size 2048;
    client_max_body_size 50m;

    # H5BP config

      # Enable gzip compression.
      include h5bp/web_performance/compression.conf;

      # Specify file cache expiration.
      include h5bp/web_performance/cache_expiration.conf;

      # Add X-XSS-Protection for HTML documents.
      # h5bp/security/x-xss-protection.conf
      map $sent_http_content_type $x_xss_protection {
        #           (1)    (2)
        ~*text/html "1; mode=block";
      }

      # Add X-Frame-Options for HTML documents.
      # h5bp/security/x-frame-options.conf
      map $sent_http_content_type $x_frame_options {
        ~*text/html DENY;
      }

      # Add Content-Security-Policy for HTML documents.
      # h5bp/security/content-security-policy.conf
      map $sent_http_content_type $content_security_policy {
        ~*text/(html|javascript)|application/pdf|xml "default-src 'self'; base-uri 'none'; form-action 'self'; frame-ancestors 'none'; upgrade-insecure-requests";
      }

      # Add Referrer-Policy for HTML documents.
      # h5bp/security/referrer-policy.conf.conf
      map $sent_http_content_type $referrer_policy {
        ~*text/(css|html|javascript)|application\/pdf|xml "strict-origin-when-cross-origin";
      }

      # Add X-UA-Compatible for HTML documents.
      # h5bp/internet_explorer/x-ua-compatible.conf
      map $sent_http_content_type $x_ua_compatible {
        ~*text/html "IE=edge";
      }

      # Add Access-Control-Allow-Origin.
      # h5bp/cross-origin/requests.conf
      map $sent_http_content_type $cors {
        # Images
        ~*image/ "*";

        # Web fonts
        ~*font/                         "*";
        ~*application/vnd.ms-fontobject "*";
        ~*application/x-font-ttf        "*";
        ~*application/font-woff         "*";
        ~*application/x-font-woff       "*";
        ~*application/font-woff2        "*";
      }
    # H5BP config - END

    # Load modular configuration files from the /etc/nginx/conf.d directory.
    # See http://nginx.org/en/docs/ngx_core_module.html#include
    # for more information.
    include /etc/nginx/conf.d/*.conf;

    index   index.html index.htm;

}
